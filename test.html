<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />

  <script type="text/javascript" src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
  <script type="text/javascript" src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

  <script type="text/javascript" type="text/javascript">
    // Connecting to ROS
    // -----------------

    var ros = new ROSLIB.Ros({
      // url: 'ws://warr-rover.lrt.mw.tum.de:9090'
      url: 'ws://10.0.0.1:9090'
    });

    ros.on('connection', function () {
      console.log('Connected to websocket server.');
    });

    ros.on('error', function (error) {
      console.log('Error connecting to websocket server: ', error);
    });

    ros.on('close', function () {
      console.log('Connection to websocket server closed.');
    });

    // Publishing a Topic
    // ------------------

    var cmdVel = new ROSLIB.Topic({
      ros: ros,
      name: '/motor_driver',
      messageType: 'exploration_rover_i/motor_ror'
    });

  </script>
  <style>
    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 25px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider:hover {
      opacity: 1;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      background: #4CAF50;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      background: #4CAF50;
      cursor: pointer;
    }

  </style>

</head>

<body>
    <div style="display: none;">
  <h1>Simple roslib Example</h1>
  <p>Check your Web Console for output.</p>
    <input type="range" min="-1500" max="1500" value="0" class="slider" id="myRange" step="100">
    <span id="demo"></span>

    <input type="text" id="test">
  </div>
  <div style="display: flex; ">
    <!-- <div>
            <img src="http://warr-rover.lrt.mw.tum.de:8080/stream?topic=/left/image_raw&quality=30&width=500&height=500" style="width: 100%;">
        </div>
        <div>
            <img src="http://warr-rover.lrt.mw.tum.de:8080/stream?topic=/right/image_raw&quality=30&width=500&height=500" style="width: 100%;">
        </div> -->

    <div style="flex-grow: 1;">
        <img src="http://10.0.0.1:8080/stream?topic=/left/image_raw&quality=30&width=500&height=400" style="width: 100%;">
    </div>
    <div style="flex-grow: 1;">
      <img src="http://10.0.0.1:8080/stream?topic=/right/image_raw&quality=30&width=500&height=400" style="width: 100%;">
    </div>

  </div>

  <script>
    var slider = document.getElementById("myRange");
    var output = document.getElementById("demo");
    var test = document.getElementById("test");
    output.innerHTML = slider.value; // Display the default slider value

    test.oninput = function () {
      slider.value = parseInt(this.value);
    }

    // Update the current slider value (each time you drag the slider handle)
    slider.oninput = function () {
      output.innerHTML = this.value;

      var twist = new ROSLIB.Message({
        address: 2,
        value: parseInt(this.value),
      });
      cmdVel.publish(twist);
    }

    var start;

    window.addEventListener("gamepadconnected", function (e) {
      gameLoop();
    });

    window.addEventListener("gamepaddisconnected", function (e) {
      cancelRequestAnimationFrame(start);
    });

    function gameLoop() {
      var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads :
        []);
      if (!gamepads) {
        return;
      }

      var gp = gamepads[0];
      var x = (Math.abs(gp.axes[0]) < 0.05) ? 0 : gp.axes[0];
      var y = (Math.abs(gp.axes[1]) < 0.05) ? 0 : gp.axes[1];

      var speed = y * 1500;
      var side = x * 1500;

      var valueLeft = speed - side;
      var valueRight = speed + side;


      for (var i = 1; i <= 4; i++) {
        var twist = new ROSLIB.Message({
          address: i,
          value: (i <= 2) ? -Math.trunc(valueRight) : Math.trunc(valueLeft),
        });
        cmdVel.publish(twist);
      }

      setTimeout(function () {
        start = requestAnimationFrame(gameLoop);
      }, 1000 / 20);
    }

  </script>

</body>

</html>
